name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  lua:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Lua
        uses: leafo/gh-actions-lua@35bcb06abec04ec87df82e08caa84d545348536e
        with:
          luaVersion: "5.4"

      - name: Set up LuaRocks
        uses: leafo/gh-actions-luarocks@97053c556d6ce2c8e26eb7ac93743437c7af7248

      - name: Set up StyLua
        uses: JohnnyMorganz/stylua-action@479972f01e665acfcba96ada452c36608bdbbb5e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: "2.3.1"

      - name: Install tools
        run: make tools

      - name: Format check
        run: make fmt-check

      - name: Lint
        run: make lint

      - name: Test
        run: make test

  gitleaks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc
        with:
          args: "--redact --verbose"

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Dependency review
        uses: actions/dependency-review-action@46a3c492319c890177366b6ef46d6b4f89743ed4

  semgrep:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.x"
      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep
      - name: SAST (Semgrep)
        run: semgrep --config=auto --error --metrics=off --severity=ERROR
